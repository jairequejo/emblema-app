// dashboard/dashboard.js — JR Stars v4

constAPI_URL = "";  // rutas relativas, sin ngrok
const HEADERS  = { 'Accept': 'application/json' };
const MESES    = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
const DIAS     = ['Do','Lu','Ma','Mi','Ju','Vi','Sa'];

// Horarios: LMV = días 1,3,5 | MJS = días 2,4,6
const SCHEDULE = {
    'LMV': [1, 3, 5],
    'MJS': [2, 4, 6],
};

let currentDate  = new Date();
let currentYear  = currentDate.getFullYear();
let currentMonth = currentDate.getMonth();
let allStudents  = [];
let attendanceMap = {};

// ── NAVEGACIÓN DE MES ──────────────────────────────────
function changeMonth(delta) {
    currentMonth += delta;
    if (currentMonth > 11) { currentMonth = 0; currentYear++; }
    if (currentMonth < 0)  { currentMonth = 11; currentYear--; }
    loadData();
}

function updateMonthLabel() {
    document.getElementById('month-label').textContent =
        `${MESES[currentMonth]} ${currentYear}`;
}

// ── CARGA DE DATOS ─────────────────────────────────────
async function loadData() {
    document.getElementById('loading').style.display = 'flex';
    document.getElementById('table-container').innerHTML = '';
    updateMonthLabel();

    try {
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const mm    = String(currentMonth + 1).padStart(2, '0');
        const dd    = String(daysInMonth).padStart(2, '0');
        const first = `${currentYear}-${mm}-01T00:00:00`;
        const last  = `${currentYear}-${mm}-${dd}T23:59:59`;
        const ts    = Date.now();

        const [studRes, rangeRes] = await Promise.all([
            fetch(`${API_URL}/students?_=${ts}`,                                            { headers: HEADERS }),
            fetch(`${API_URL}/attendance/range?start=${first}&end=${last}&_=${ts}`, { headers: HEADERS })
        ]);

        if (!studRes.ok) throw new Error(`Error alumnos: ${studRes.status}`);
        if (!rangeRes.ok) throw new Error(`Error asistencia: ${rangeRes.status}`);

        allStudents = await studRes.json();
        const attData = await rangeRes.json();

        // Construir mapa student_id + fecha → true
        attendanceMap = {};
        attData.forEach(r => {
            if (r.student_id && r.created_at) {
                const fecha = r.created_at.substring(0, 10);
                attendanceMap[`${r.student_id}_${fecha}`] = true;
            }
        });

        // Poblar filtro de sedes dinámicamente
        const sedeSelect = document.getElementById('filter-sede');
        const sedes = [...new Set(allStudents.map(s => s.sede).filter(Boolean))];
        sedeSelect.innerHTML = '<option value="">Todas las sedes</option>';
        sedes.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s; opt.textContent = s;
            sedeSelect.appendChild(opt);
        });

        renderTable();
        document.getElementById('last-update').textContent =
            `Actualizado: ${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;

    } catch(e) {
        console.error("❌ Error:", e);
        document.getElementById('loading').innerHTML =
            `<span style="color:var(--red2);font-family:var(--font-cond);letter-spacing:.1em">❌ ${e.message}</span>`;
        return;
    }

    document.getElementById('loading').style.display = 'none';
}

// ── FILTROS ────────────────────────────────────────────
function applyFilters() { renderTable(); }

// ── RENDERIZADO ────────────────────────────────────────
function renderTable() {
    const turnoFilter  = document.getElementById('filter-turno').value;
    const sedeFilter   = document.getElementById('filter-sede').value;
    const searchFilter = document.getElementById('search').value.toLowerCase();

    const students = allStudents.filter(s => {
        const matchSearch = (s.full_name || '').toLowerCase().includes(searchFilter);
        const matchTurno  = !turnoFilter || (s.turno || '') === turnoFilter;
        const matchSede   = !sedeFilter  || (s.sede  || '') === sedeFilter;
        return matchSearch && matchTurno && matchSede;
    });

    const today          = new Date();
    const isCurrentMonth = (today.getMonth() === currentMonth && today.getFullYear() === currentYear);
    const todayDay       = today.getDate();
    const daysInMonth    = new Date(currentYear, currentMonth + 1, 0).getDate();
    const mm             = String(currentMonth + 1).padStart(2, '0');
    const todayStr       = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

    // Construir array de días del mes
    const days = [];
    for (let d = 1; d <= daysInMonth; d++) {
        days.push({ day: d, dow: new Date(currentYear, currentMonth, d).getDay() });
    }

    // ── Stats globales ──
    let totalPresencias = 0, totalEsperadas = 0, presentHoy = 0;

    students.forEach(s => {
        const schedule = SCHEDULE[s.horario] || null; // null = todos los días hábiles
        days.forEach(({ day, dow }) => {
            if (dow === 0) return; // domingo siempre libre
            const dateStr = `${currentYear}-${mm}-${String(day).padStart(2,'0')}`;
            if (new Date(currentYear, currentMonth, day) > today) return;
            // Si tiene horario definido, solo contar sus días
            if (schedule && !schedule.includes(dow)) return;
            // Sábado libre si no tiene MJS
            if (dow === 6 && (!schedule || !schedule.includes(6))) return;
            totalEsperadas++;
            if (attendanceMap[`${s.id}_${dateStr}`]) {
                totalPresencias++;
                if (dateStr === todayStr) presentHoy++;
            }
        });
    });

    document.getElementById('stat-total').textContent   = students.length;
    document.getElementById('stat-present').textContent = presentHoy;
    document.getElementById('stat-absent').textContent  = Math.max(0, students.length - presentHoy);
    document.getElementById('stat-pct').textContent     = totalEsperadas > 0
        ? `${Math.round((totalPresencias / totalEsperadas) * 100)}%` : '—';

    if (students.length === 0) {
        document.getElementById('table-container').innerHTML = `
            <div class="empty-state">
                <div class="big">—</div>
                <p>No se encontraron alumnos</p>
            </div>`;
        return;
    }

    // ── Tabla HTML ──
    let html = `<table class="attendance-table"><thead><tr>
        <th style="min-width:160px">Alumno</th>`;

    days.forEach(({ day, dow }) => {
        const isToday   = isCurrentMonth && day === todayDay;
        const isWeekend = dow === 0 || dow === 6;
        const cls = isToday ? 'day-col today-h' : isWeekend ? 'day-col weekend-h' : 'day-col';
        html += `<th class="${cls}">${DIAS[dow]}<br>${day}</th>`;
    });
    html += `<th style="min-width:52px;border-left:1px solid var(--border);text-align:center">%</th>
        </tr></thead><tbody>`;

    students.forEach(s => {
        const schedule = SCHEDULE[s.horario] || null;
        let presentCount = 0, workdayCount = 0;

        // Badge de horario
        const horarioBadge = s.horario
            ? `<span style="font-size:.65rem;font-family:var(--font-cond);letter-spacing:.1em;color:var(--gold);margin-left:.4rem">${s.horario}</span>`
            : '';

        html += `<tr>
            <td>
                <div class="student-name">${s.full_name}${horarioBadge}</div>
                ${s.sede ? `<div class="student-sede">${s.sede}</div>` : ''}
            </td>`;

        days.forEach(({ day, dow }) => {
            const isToday   = isCurrentMonth && day === todayDay;
            const dateStr   = `${currentYear}-${mm}-${String(day).padStart(2,'0')}`;
            const isFuture  = new Date(currentYear, currentMonth, day) > today;
            const isPresent = attendanceMap[`${s.id}_${dateStr}`];
            const todayCls  = isToday ? ' day-today' : '';

            const isDomingo = dow === 0;
            const isSabado  = dow === 6;
            const esDiaAlumno = schedule
                ? schedule.includes(dow)
                : (!isDomingo && !isSabado);  // sin horario: L-V

            if (isDomingo || (isSabado && (!schedule || !schedule.includes(6)))) {
                // Día libre para este alumno
                html += `<td><div class="day-cell day-weekend">—</div></td>`;
            } else if (!esDiaAlumno) {
                // Día que no le corresponde (ej: alumno LMV ve martes en gris)
                html += `<td><div class="day-cell day-weekend" style="opacity:.3">·</div></td>`;
            } else if (isFuture) {
                html += `<td><div class="day-cell day-future">·</div></td>`;
            } else {
                workdayCount++;
                if (isPresent) {
                    presentCount++;
                    html += `<td><div class="day-cell day-present${todayCls}" title="${dateStr}">✓</div></td>`;
                } else {
                    html += `<td><div class="day-cell day-absent${todayCls}" title="${dateStr}">✗</div></td>`;
                }
            }
        });

        const pct = workdayCount > 0 ? Math.round((presentCount / workdayCount) * 100) : 0;
        const pctClass = pct >= 80 ? 'pct-high' : pct >= 50 ? 'pct-mid' : 'pct-low';
        html += `<td style="text-align:center"><span class="pct-cell ${pctClass}">${pct}%</span></td></tr>`;
    });

    html += '</tbody></table>';
    document.getElementById('table-container').innerHTML = html;
}

// ── INICIO ─────────────────────────────────────────────
loadData();
setInterval(loadData, 60000);
