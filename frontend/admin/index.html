<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JR Stars â€” Admin Panel</title>
  <link rel="stylesheet" href="/static/theme.css">
  <link rel="icon" href="/static/favicon.ico">
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { display:flex; flex-direction:column; min-height:100vh; }

    /* â”€â”€ SIDEBAR + MAIN â”€â”€ */
    .admin-layout {
      display: grid;
      grid-template-columns: 220px 1fr;
      flex: 1;
      min-height: calc(100vh - 57px);
    }
    @media(max-width:750px){
      .admin-layout { grid-template-columns: 1fr; }
      .sidebar { display: none; }
      .sidebar.open { display: flex; position:fixed; inset:0; z-index:200; width:220px; }
    }

    /* â”€â”€ SIDEBAR â”€â”€ */
    .sidebar {
      background: var(--dark);
      border-right: 1px solid var(--border);
      display: flex; flex-direction: column;
      padding: 1rem 0;
    }
    .sidebar-section {
      font-family: var(--font-cond);
      font-size: .65rem; font-weight: 700;
      letter-spacing: .3em; text-transform: uppercase;
      color: var(--gray2); padding: .8rem 1.2rem .3rem;
    }
    .sidebar-item {
      display: flex; align-items: center; gap: .7rem;
      padding: .65rem 1.2rem;
      font-family: var(--font-cond); font-size: .95rem;
      font-weight: 600; letter-spacing: .06em;
      color: var(--gray); cursor: pointer;
      transition: color .2s, background .2s;
      border-left: 3px solid transparent;
    }
    .sidebar-item:hover { color: var(--white); background: rgba(255,255,255,.03); }
    .sidebar-item.active {
      color: var(--gold);
      border-left-color: var(--gold);
      background: rgba(212,160,23,.06);
    }
    .sidebar-icon { font-size: 1.1rem; width: 22px; text-align: center; }

    .sidebar-logout {
      margin-top: auto;
      border-top: 1px solid var(--border);
      padding-top: .5rem;
    }

    /* â”€â”€ MAIN CONTENT â”€â”€ */
    .main-content {
      overflow-y: auto;
      background: var(--black);
    }

    .page { display: none; padding: 2rem; }
    .page.active { display: block; }

    .page-header {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      flex-wrap: wrap; gap: 1rem;
    }
    .page-title {
      font-family: var(--font-display);
      font-size: 2rem; letter-spacing: .06em;
    }
    .page-title span { color: var(--gold); }

    /* â”€â”€ STATS GRID â”€â”€ */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1px; background: var(--border);
      margin-bottom: 2rem;
    }

    /* â”€â”€ TABLA ADMIN â”€â”€ */
    .admin-table {
      width: 100%; border-collapse: collapse;
      font-family: var(--font-cond); font-size: .9rem;
    }
    .admin-table th {
      font-size: .7rem; font-weight: 700;
      letter-spacing: .2em; text-transform: uppercase;
      color: var(--gray); background: var(--dark);
      padding: .7rem 1rem; text-align: left;
      border-bottom: 1px solid var(--border);
    }
    .admin-table td {
      padding: .7rem 1rem;
      border-bottom: 1px solid rgba(255,255,255,.03);
      color: var(--white);
    }
    .admin-table tr:hover td { background: rgba(212,160,23,.03); }

    /* â”€â”€ FORM CARD â”€â”€ */
    .form-card {
      background: var(--card);
      border: 1px solid var(--border);
      padding: 1.5rem; margin-bottom: 2rem;
    }
    .form-card-title {
      font-family: var(--font-display); font-size: 1.2rem;
      letter-spacing: .06em; margin-bottom: 1.2rem;
      color: var(--gold);
    }
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem; margin-bottom: 1rem;
    }
    .form-group { display: flex; flex-direction: column; gap: .3rem; }
    .form-label {
      font-family: var(--font-cond); font-size: .72rem;
      font-weight: 700; letter-spacing: .2em;
      text-transform: uppercase; color: var(--gray);
    }

    /* â”€â”€ SCANNER ADMIN â”€â”€ */
    .scanner-admin-wrap {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }
    @media(max-width:700px){ .scanner-admin-wrap { grid-template-columns: 1fr; } }

    #admin-reader {
      border: 2px solid var(--border);
      position: relative; overflow: hidden;
    }
    #admin-reader::before {
      content: '';
      position: absolute; inset: 0;
      border: 3px solid var(--gold);
      pointer-events: none; z-index: 10;
      animation: scan-border 2s ease-in-out infinite;
    }
    @keyframes scan-border {
      0%,100% { opacity:.3; } 50% { opacity:1; }
    }

    .scan-result {
      padding: 1.2rem 1.5rem;
      border: 1px solid var(--border);
      background: var(--card);
      margin-top: 1rem;
      display: none;
      animation: fadeUp .3s ease;
    }
    .scan-result.success { border-color: var(--green); background: var(--green-bg); }
    .scan-result.error   { border-color: var(--red2);  background: var(--red-bg); }
    .scan-result.warning { border-color: var(--gold);  background: var(--gold-bg); }

    /* noticia card */
    .noticia-admin-card {
      background: var(--card);
      border: 1px solid var(--border);
      padding: 1.2rem;
      display: flex; gap: 1rem; align-items: flex-start;
      margin-bottom: .6rem;
    }
    .noticia-admin-card .emoji { font-size: 1.8rem; flex-shrink:0; }
    .noticia-admin-card .info { flex:1; }
    .noticia-admin-card .titulo {
      font-family: var(--font-cond); font-weight:700; font-size:1rem;
      color:var(--white); margin-bottom:.2rem;
    }
    .noticia-admin-card .desc {
      font-size:.82rem; color:var(--gray); line-height:1.5;
    }
    .noticia-admin-card .meta {
      font-family:var(--font-mono); font-size:.7rem; color:var(--gray2); margin-top:.3rem;
    }

    /* crÃ©ditos row */
    .credit-row {
      display: flex; align-items: center; gap: 1rem;
      padding: .7rem 0; border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .credit-name {
      font-family: var(--font-cond); font-weight:700; flex:1;
      min-width: 120px;
    }
    .credit-bal {
      font-family: var(--font-display); font-size:1.4rem; color:var(--gold);
      min-width: 50px; text-align:right;
    }
    .credit-input {
      width: 70px;
    }

    /* notif toast */
    .toast {
      position: fixed; bottom: 2rem; right: 2rem; z-index: 999;
      background: var(--card); border: 1px solid var(--green);
      padding: .8rem 1.4rem;
      font-family: var(--font-cond); font-size: .9rem;
      color: var(--green); letter-spacing: .06em;
      animation: fadeUp .3s ease;
      display: none;
    }
    .toast.visible { display: block; }
    .toast.error { border-color: var(--red2); color: var(--red2); }
  </style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <a href="/" class="topbar-brand">
    <div class="topbar-logo-circle">
      <img src="/static/img/logo.png" alt="logo" onload="this.classList.add('loaded')">
      <span>â­</span>
    </div>
    <span class="topbar-name">JR <span>STARS</span></span>
  </a>
  <div class="topbar-right">
    <span style="font-family:var(--font-mono);font-size:.75rem;color:var(--gray)" id="admin-email"></span>
    <a href="/" class="btn btn-outline">â† Inicio</a>
  </div>
</div>

<!-- LAYOUT -->
<div class="admin-layout">

  <!-- SIDEBAR -->
  <nav class="sidebar">
    <div class="sidebar-section">Principal</div>
    <div class="sidebar-item active" onclick="goTo('stats')">
      <span class="sidebar-icon">ğŸ“Š</span> EstadÃ­sticas
    </div>
    <div class="sidebar-item" onclick="goTo('scanner')">
      <span class="sidebar-icon">ğŸ“·</span> Scanner
    </div>

    <div class="sidebar-section">GestiÃ³n</div>
    <div class="sidebar-item" onclick="goTo('alumnos')">
      <span class="sidebar-icon">ğŸ‘¥</span> Alumnos
    </div>
    <div class="sidebar-item" onclick="goTo('batidos')">
      <span class="sidebar-icon">ğŸ¥¤</span> Batidos
    </div>

    <div class="sidebar-section">Contenido</div>
    <div class="sidebar-item" onclick="goTo('noticias')">
      <span class="sidebar-icon">ğŸ“¢</span> Noticias
    </div>
    <div class="sidebar-item" onclick="goTo('fotos')">
      <span class="sidebar-icon">ğŸ–¼ï¸</span> GalerÃ­a
    </div>

    <div class="sidebar-logout">
      <div class="sidebar-item" onclick="logout()" style="color:var(--red2)">
        <span class="sidebar-icon">ğŸšª</span> Cerrar sesiÃ³n
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="main-content">

    <!-- â”€â”€ STATS â”€â”€ -->
    <div class="page active" id="page-stats">
      <div class="page-header">
        <div class="page-title">Panel <span>Admin</span></div>
        <button class="btn btn-gold" onclick="loadStats()">âŸ³ Actualizar</button>
      </div>
      <div class="stats-row" id="stats-row">
        <div class="stat-box"><div class="stat-box-num white" id="s-total">â€”</div><div class="stat-box-label">Total alumnos</div></div>
        <div class="stat-box"><div class="stat-box-num green" id="s-presentes">â€”</div><div class="stat-box-label">Presentes hoy</div></div>
        <div class="stat-box"><div class="stat-box-num red"   id="s-ausentes">â€”</div><div class="stat-box-label">Ausentes hoy</div></div>
        <div class="stat-box"><div class="stat-box-num"       id="s-fecha">â€”</div><div class="stat-box-label">Fecha</div></div>
      </div>
      <div style="font-family:var(--font-cond);color:var(--gray);font-size:.9rem;letter-spacing:.06em">
        Selecciona un mÃ³dulo del menÃº para gestionar tu academia.
      </div>
    </div>

    <!-- â”€â”€ SCANNER â”€â”€ -->
    <div class="page" id="page-scanner">
      <div class="page-header">
        <div class="page-title">ğŸ“· <span>Scanner</span></div>
      </div>
      <div class="scanner-admin-wrap">
        <div>
          <div id="admin-reader"></div>
          <div id="scan-result" class="scan-result"></div>
        </div>
        <div>
          <div style="font-family:var(--font-display);font-size:1.2rem;margin-bottom:1rem;color:var(--gold)">
            ÃšLTIMOS REGISTROS
          </div>
          <ul id="scan-history" style="list-style:none;"></ul>
        </div>
      </div>
    </div>

    <!-- â”€â”€ ALUMNOS â”€â”€ -->
    <div class="page" id="page-alumnos">
      <div class="page-header">
        <div class="page-title">ğŸ‘¥ <span>Alumnos</span></div>
      </div>

      <!-- Formulario nuevo alumno -->
      <div class="form-card">
        <div class="form-card-title">+ Nuevo alumno</div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Nombre completo</label>
            <input class="input-jr" id="a-nombre" placeholder="Nombre Apellido">
          </div>
          <div class="form-group">
            <label class="form-label">Horario</label>
            <select class="select-jr" id="a-horario">
              <option value="LMV">Lunes, MiÃ©rcoles, Viernes</option>
              <option value="MJS">Martes, Jueves, SÃ¡bado</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Turno</label>
            <select class="select-jr" id="a-turno">
              <option value="">Sin turno</option>
              <option value="maÃ±ana">MaÃ±ana</option>
              <option value="tarde">Tarde</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Sede</label>
            <input class="input-jr" id="a-sede" placeholder="Sede (opcional)">
          </div>
        </div>
        <button class="btn btn-gold" onclick="crearAlumno()">+ Agregar alumno</button>
      </div>

      <!-- Lista alumnos -->
      <div id="alumnos-list"></div>
    </div>

    <!-- â”€â”€ BATIDOS / CRÃ‰DITOS â”€â”€ -->
    <div class="page" id="page-batidos">
      <div class="page-header">
        <div class="page-title">ğŸ¥¤ <span>CrÃ©ditos</span></div>
      </div>
      <div class="form-card" style="margin-bottom:1.5rem;">
        <div class="form-card-title">ğŸ’¡ CÃ³mo recargar</div>
        <p style="font-family:var(--font-cond);font-size:.9rem;color:var(--gray);line-height:1.6">
          El padre paga por Yape/Plin â†’ tÃº buscas al alumno abajo â†’ ingresas la cantidad de crÃ©ditos y das clic en <strong style="color:var(--gold)">Recargar</strong>.
        </p>
      </div>
      <div id="creditos-list"></div>
    </div>

    <!-- â”€â”€ NOTICIAS â”€â”€ -->
    <div class="page" id="page-noticias">
      <div class="page-header">
        <div class="page-title">ğŸ“¢ <span>Noticias</span></div>
      </div>

      <div class="form-card">
        <div class="form-card-title">+ Nueva noticia</div>
        <div class="form-row">
          <div class="form-group" style="grid-column:span 2">
            <label class="form-label">TÃ­tulo</label>
            <input class="input-jr" id="n-titulo" placeholder="TÃ­tulo de la noticia">
          </div>
          <div class="form-group">
            <label class="form-label">CategorÃ­a</label>
            <select class="select-jr" id="n-categoria">
              <option value="aviso">ğŸ“¢ Aviso</option>
              <option value="torneo">ğŸ† Torneo</option>
              <option value="logro">â­ Logro</option>
              <option value="batido">ğŸ¥¤ Batidos</option>
              <option value="horario">ğŸ“… Horario</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Emoji</label>
            <input class="input-jr" id="n-emoji" placeholder="ğŸ“¢" value="ğŸ“¢" style="max-width:80px">
          </div>
        </div>
        <div class="form-group" style="margin-bottom:1rem">
          <label class="form-label">DescripciÃ³n</label>
          <textarea class="input-jr" id="n-desc" rows="3"
            placeholder="DescripciÃ³n de la noticia..."
            style="resize:vertical;"></textarea>
        </div>
        <div class="form-group" style="margin-bottom:1rem">
          <label class="form-label">URL de imagen (opcional)</label>
          <input class="input-jr" id="n-imagen" placeholder="https://... (sube la foto a Supabase Storage)">
        </div>
        <button class="btn btn-gold" onclick="crearNoticia()">ğŸ“¢ Publicar noticia</button>
      </div>

      <div id="noticias-list"></div>
    </div>

    <!-- â”€â”€ GALERÃA â”€â”€ -->
    <div class="page" id="page-fotos">
      <div class="page-header">
        <div class="page-title">ğŸ–¼ï¸ <span>GalerÃ­a</span></div>
      </div>
      <div class="form-card">
        <div class="form-card-title">+ Agregar foto</div>
        <div class="form-row">
          <div class="form-group" style="grid-column:span 2">
            <label class="form-label">URL de la foto</label>
            <input class="input-jr" id="f-url" placeholder="https://... (sube a Supabase Storage y pega el link)">
          </div>
          <div class="form-group">
            <label class="form-label">DescripciÃ³n</label>
            <input class="input-jr" id="f-desc" placeholder="Ej: Entrenamiento enero 2026">
          </div>
        </div>
        <button class="btn btn-gold" onclick="agregarFoto()">ğŸ–¼ï¸ Agregar foto</button>
        <p style="font-family:var(--font-cond);font-size:.78rem;color:var(--gray);margin-top:.8rem">
          ğŸ’¡ Para subir fotos: Supabase â†’ Storage â†’ New bucket "fotos" â†’ Upload â†’ Copy URL
        </p>
      </div>
      <div id="fotos-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:1rem;margin-top:1rem;"></div>
    </div>

  </main>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
  // â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const token = localStorage.getItem('jr_admin_token');
  if (!token) window.location.href = '/admin/login';

  document.getElementById('admin-email').textContent =
    localStorage.getItem('jr_admin_email') || '';

  const H = {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  };

  function logout() {
    localStorage.removeItem('jr_admin_token');
    localStorage.removeItem('jr_admin_email');
    window.location.href = '/admin/login';
  }

  // â”€â”€ NAVEGACIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let scannerInit = false;

  function goTo(page) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
    document.getElementById(`page-${page}`).classList.add('active');
    event.currentTarget.classList.add('active');

    if (page === 'stats')    loadStats();
    if (page === 'alumnos')  loadAlumnos();
    if (page === 'batidos')  loadCreditos();
    if (page === 'noticias') loadNoticias();
    if (page === 'fotos')    loadFotos();
    if (page === 'scanner' && !scannerInit) initScanner();
  }

  // â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showToast(msg, type='ok') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = `toast visible ${type === 'error' ? 'error' : ''}`;
    setTimeout(() => t.classList.remove('visible'), 3000);
  }

  // â”€â”€ STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadStats() {
    try {
      const res = await fetch('/admin/stats', { headers: H });
      if (res.status === 401) { logout(); return; }
      const d = await res.json();
      document.getElementById('s-total').textContent     = d.total_alumnos;
      document.getElementById('s-presentes').textContent = d.presentes_hoy;
      document.getElementById('s-ausentes').textContent  = d.ausentes_hoy;
      document.getElementById('s-fecha').textContent     = d.fecha;
    } catch {}
  }

  // â”€â”€ SCANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function initScanner() {
    scannerInit = true;
    const scanner = new Html5QrcodeScanner('admin-reader', {
      fps: 15, qrbox: { width: 250, height: 250 }
    });
    scanner.render(async (code) => {
      scanner.pause();
      const clean = code.includes('?code=') ? code.split('?code=')[1] : code;
      try {
        const res = await fetch('/attendance/scan', {
          method: 'POST',
          headers: H,
          body: JSON.stringify({ code: clean })
        });
        const d = await res.json();
        const el = document.getElementById('scan-result');
        el.style.display = 'block';
        el.className = `scan-result ${d.status}`;
        el.innerHTML = d.message;

        // agregar al historial
        const li = document.createElement('li');
        li.style.cssText = 'padding:.5rem 0;border-bottom:1px solid var(--border);font-family:var(--font-cond);font-size:.9rem';
        li.innerHTML = `<strong style="color:var(--gold)">${new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</strong> â€” ${d.student_name || clean}`;
        document.getElementById('scan-history').prepend(li);

        setTimeout(() => { el.style.display = 'none'; scanner.resume(); }, 2500);
      } catch { setTimeout(() => scanner.resume(), 2000); }
    });
  }

  // â”€â”€ ALUMNOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadAlumnos() {
    const res = await fetch('/admin/alumnos', { headers: H });
    if (res.status === 401) { logout(); return; }
    const data = await res.json();
    const container = document.getElementById('alumnos-list');
    if (!data.length) { container.innerHTML = '<p style="color:var(--gray);font-family:var(--font-cond)">No hay alumnos aÃºn.</p>'; return; }

    container.innerHTML = `
      <table class="admin-table">
        <thead><tr>
          <th>Nombre</th><th>Horario</th><th>Turno</th><th>Sede</th><th>CrÃ©ditos</th><th>Acciones</th>
        </tr></thead>
        <tbody>
          ${data.map(a => `
            <tr>
              <td><strong>${a.full_name}</strong></td>
              <td><span class="badge badge-gold">${a.horario || 'LMV'}</span></td>
              <td>${a.turno || 'â€”'}</td>
              <td>${a.sede || 'â€”'}</td>
              <td><span style="font-family:var(--font-display);color:var(--gold)">${a.batido_credits ?? 0}</span></td>
              <td>
                <button class="btn btn-outline" style="font-size:.75rem;padding:.3rem .7rem"
                  onclick="verQR('${a.id}')">QR</button>
                <button class="btn btn-red" style="font-size:.75rem;padding:.3rem .7rem;margin-left:.3rem"
                  onclick="eliminarAlumno('${a.id}','${a.full_name}')">âœ•</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>`;
  }

  async function crearAlumno() {
    const nombre = document.getElementById('a-nombre').value.trim();
    if (!nombre) return;
    const res = await fetch('/admin/alumnos', {
      method: 'POST', headers: H,
      body: JSON.stringify({
        full_name: nombre,
        horario: document.getElementById('a-horario').value,
        turno: document.getElementById('a-turno').value || null,
        sede: document.getElementById('a-sede').value || null,
      })
    });
    if (res.ok) {
      document.getElementById('a-nombre').value = '';
      showToast('âœ… Alumno agregado');
      loadAlumnos();
    } else showToast('âŒ Error al agregar', 'error');
  }

  async function eliminarAlumno(id, nombre) {
    if (!confirm(`Â¿Desactivar a ${nombre}?`)) return;
    await fetch(`/admin/alumnos/${id}`, { method: 'DELETE', headers: H });
    showToast('âœ… Alumno desactivado');
    loadAlumnos();
  }

  async function verQR(studentId) {
    const res = await fetch(`/credentials/${studentId}`, { headers: H });
    const data = await res.json();
    if (data.length) window.open(`/qrs/${data[0].code}.png`, '_blank');
    else {
      const gen = await fetch(`/credentials/generate/${studentId}`, { method:'POST', headers: H });
      const d = await gen.json();
      window.open(d.qr_url, '_blank');
    }
  }

  // â”€â”€ CRÃ‰DITOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadCreditos() {
    const res = await fetch('/admin/alumnos', { headers: H });
    const data = await res.json();
    document.getElementById('creditos-list').innerHTML = data.map(a => `
      <div class="credit-row">
        <span class="credit-name">${a.full_name}</span>
        <span class="credit-bal">${a.batido_credits ?? 0} cr.</span>
        <input class="input-jr credit-input" type="number" min="1" max="20"
          value="4" id="cr-${a.id}">
        <button class="btn btn-gold" style="padding:.4rem 1rem;font-size:.85rem"
          onclick="recargar('${a.id}')">+ Recargar</button>
      </div>
    `).join('');
  }

  async function recargar(id) {
    const cantidad = parseInt(document.getElementById(`cr-${id}`).value) || 4;
    const res = await fetch('/admin/batidos/recargar', {
      method: 'POST', headers: H,
      body: JSON.stringify({ student_id: id, cantidad, motivo: 'Recarga Yape/Plin' })
    });
    const d = await res.json();
    if (res.ok) { showToast(`âœ… ${d.alumno}: ahora tiene ${d.creditos_nuevos} cr.`); loadCreditos(); }
    else showToast('âŒ Error al recargar', 'error');
  }

  // â”€â”€ NOTICIAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadNoticias() {
    const res = await fetch('/admin/noticias', { headers: H });
    const data = await res.json();
    const container = document.getElementById('noticias-list');
    if (!data.length) { container.innerHTML = '<p style="color:var(--gray);font-family:var(--font-cond)">No hay noticias publicadas.</p>'; return; }
    container.innerHTML = data.map(n => `
      <div class="noticia-admin-card">
        <span class="emoji">${n.emoji || 'ğŸ“¢'}</span>
        <div class="info">
          <div class="titulo">${n.titulo}</div>
          <div class="desc">${n.descripcion}</div>
          <div class="meta">${new Date(n.created_at).toLocaleDateString('es-PE')} Â· ${n.categoria}</div>
        </div>
        <button class="btn btn-red" style="font-size:.75rem;padding:.3rem .7rem;flex-shrink:0"
          onclick="eliminarNoticia('${n.id}')">âœ•</button>
      </div>
    `).join('');
  }

  async function crearNoticia() {
    const titulo = document.getElementById('n-titulo').value.trim();
    const desc   = document.getElementById('n-desc').value.trim();
    if (!titulo || !desc) return;
    const res = await fetch('/admin/noticias', {
      method: 'POST', headers: H,
      body: JSON.stringify({
        titulo, descripcion: desc,
        categoria: document.getElementById('n-categoria').value,
        emoji: document.getElementById('n-emoji').value || 'ğŸ“¢',
        imagen_url: document.getElementById('n-imagen').value || null
      })
    });
    if (res.ok) {
      document.getElementById('n-titulo').value = '';
      document.getElementById('n-desc').value = '';
      showToast('âœ… Noticia publicada');
      loadNoticias();
    } else showToast('âŒ Error al publicar', 'error');
  }

  async function eliminarNoticia(id) {
    await fetch(`/admin/noticias/${id}`, { method: 'DELETE', headers: H });
    showToast('âœ… Noticia eliminada');
    loadNoticias();
  }

  // â”€â”€ FOTOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadFotos() {
    const res = await fetch('/admin/fotos', { headers: H });
    const data = await res.json();
    const grid = document.getElementById('fotos-grid');
    if (!data.length) { grid.innerHTML = '<p style="color:var(--gray);font-family:var(--font-cond)">No hay fotos aÃºn.</p>'; return; }
    grid.innerHTML = data.map(f => `
      <div style="position:relative;aspect-ratio:1;background:var(--card);border:1px solid var(--border);overflow:hidden">
        <img src="${f.url}" style="width:100%;height:100%;object-fit:cover" onerror="this.parentElement.innerHTML='<div style=padding:1rem;font-size:.75rem;color:var(--gray)>Error al cargar</div>'">
        <div style="position:absolute;bottom:0;left:0;right:0;background:rgba(8,8,8,.8);padding:.4rem .6rem;font-family:var(--font-cond);font-size:.72rem;color:var(--gray)">
          ${f.descripcion || ''}
          <button onclick="eliminarFoto('${f.id}')" style="float:right;background:none;border:none;color:var(--red2);cursor:pointer;font-size:.9rem">âœ•</button>
        </div>
      </div>
    `).join('');
  }

  async function agregarFoto() {
    const url  = document.getElementById('f-url').value.trim();
    const desc = document.getElementById('f-desc').value.trim();
    if (!url) return;
    const res = await fetch('/admin/fotos', {
      method: 'POST', headers: H,
      body: JSON.stringify({ url, descripcion: desc })
    });
    if (res.ok) {
      document.getElementById('f-url').value = '';
      document.getElementById('f-desc').value = '';
      showToast('âœ… Foto agregada');
      loadFotos();
    } else showToast('âŒ Error al agregar foto', 'error');
  }

  async function eliminarFoto(id) {
    await fetch(`/admin/fotos/${id}`, { method: 'DELETE', headers: H });
    showToast('âœ… Foto eliminada');
    loadFotos();
  }

  // â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  loadStats();
</script>
</body>
</html>